  let found = 0;
  let totalGuesses = 0;
  let gameStarted = false;
  let gameCompleted = false;
  const foundCities = new Set();

  const map = L.map('map').setView([20, 0], 2);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 6,
    attribution: '¬© OpenStreetMap'
  }).addTo(map);

  function showModal(html) {
    const modalContent = document.getElementById("modalContent");
    modalContent.innerHTML = html;
    document.getElementById("modal").style.display = "flex";
  }

  function closeModal() {
    document.getElementById("modal").style.display = "none";

    // Only trigger end-game modal after closing the last city modal
    if (!gameCompleted && foundCities.size === 5) {
      gameCompleted = true;
      setTimeout(() => {
        showModal(`
          <h2>üéâ You cracked the case!</h2>
          <p>You found all the cities in <strong>${totalGuesses}</strong> guesses!</p>
          <button onclick="restartGame()">Play Again</button>
          <button onclick="shareOnSlack()">Share on Slack</button>
        `);
      }, 500);
    }
  }

  function updateStatus() {
    document.getElementById("found").innerText = foundCities.size;
    document.getElementById("guesses").innerText = totalGuesses;
  }

  function handleCorrect(city, marker) {
    if (!gameStarted) return;

    marker.setIcon(new L.Icon.Default({ className: 'leaflet-marker-icon clicked-marker' }));
    totalGuesses++;

    const isNew = !foundCities.has(city.name);
    if (isNew) {
      foundCities.add(city.name);
    }

    updateStatus();
    document.getElementById("correctSound").play();

    const imageButton = `<button id="imageBtn" onclick="showImage('${city.name}')">Check this out</button>`;
    const closeButton = `<br><br><button onclick="closeModal()">Close</button>`;
    showModal(`
      <h2><img src="${city.flag}" class="flag">${city.name}, ${city.country}</h2>
      <p>${city.description}</p>
      ${imageButton}${closeButton}
    `);
  }

  function showImage(cityName) {
    const modalContent = document.getElementById("modalContent");
    if (!document.getElementById("modalImg")) {
      const img = document.createElement("img");
      img.src = `${cityName}.jpg`;
      img.alt = cityName;
      img.id = "modalImg";
      img.style.marginTop = "10px";
      modalContent.appendChild(img);
    }
  }

  function handleWrong(city, marker) {
    if (!gameStarted) return;

    marker.setIcon(new L.Icon.Default({ className: 'leaflet-marker-icon clicked-marker-wrong' }));
    totalGuesses++;
    updateStatus();
    document.getElementById("wrongSound").play();
    const li = document.createElement('li');
    li.textContent = city.name;
    document.getElementById("wrongCities").appendChild(li);

    showModal(`
      <p><strong>${city.name}</strong>: ${city.fun}</p>
      <button onclick="closeModal()">Close</button>
    `);
  }

  function restartGame() {
    location.reload();
  }

  function shareOnSlack() {
    const msg = encodeURIComponent(`I cracked the Carmen Sandiego City Hunt in ${totalGuesses} guesses! üåç Play here: [your-link]`);
    const slackURL = `https://slack.com/app_redirect?channel=general&message=${msg}`;
    window.open(slackURL, '_blank');
  }

  // Start modal
  window.onload = () => {
    showModal(`
      <h2>üïµÔ∏è Carmen Sandiego: City Hunt</h2>
      <p>Can you guess the 5 cities I‚Äôve lived in?</p>
      <button onclick="startGame()">Start Game</button>
    `);
  };

  function startGame() {
    gameStarted = true;
    closeModal();
  }

  // Add markers
  correctCities.forEach(city => {
    const marker = L.marker([city.lat, city.lon]).addTo(map);
    marker.on("click", () => handleCorrect(city, marker));
  });

  wrongCities.forEach(city => {
    const marker = L.marker([city.lat, city.lon]).addTo(map);
    marker.on("click", () => handleWrong(city, marker));
  });
